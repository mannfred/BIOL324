<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Mannfred Boehm" />


<title>R Activity 2: Mapping Species Distributions using R and GBIF</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 66px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h2 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h3 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h4 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h5 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h6 {
  padding-top: 71px;
  margin-top: -71px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">BIOL 324 Labs</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="BIOL_324_Lab_6.html">Lab 6</a>
</li>
<li>
  <a href="BIOL_324_Lab_7.html">Lab 7</a>
</li>
<li>
  <a href="BIOL_324_Lab_8.html">Lab 8</a>
</li>
<li>
  <a href="BIOL_324_Lab_9.html">Lab 9</a>
</li>
<li>
  <a href="BIOL_324_Lab_10.html">Lab 10</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">R Activity 2: Mapping Species Distributions using R and GBIF</h1>
<h4 class="author">Mannfred Boehm</h4>
<h4 class="date">06 August, 2020</h4>

</div>


<div id="motivation" class="section level4">
<h4>Motivation</h4>
<p>At its core, plant taxonomy is the science of naming and grouping plants based on their shared traits. Throughout this course we’ve seen how growth habit, morphology, and geographic distribution can provide valuable information about how to classify and define plants. When we consider geographic information, we are asking questions like “do the plants occupy similar or distinct habitats?” and “are the ranges of these plants disjunct or overlapping?”. Depending on the answer to these questions, our decision to group or separate plants (and give them different names) can be changed dramatically. In this R activity, we’ll demonstrate how we can use publically available occurence data to create distribution maps for plants and use these maps to make taxonomic decisions.</p>
<p>   </p>
<hr />
</div>
<div id="pre-lab" class="section level4">
<h4>Pre-lab</h4>
<p>Before starting this week’s tutorial you will have:</p>
<ol style="list-style-type: decimal">
<li><p>completed R Activity 1 and the pre-readings assigned there,</p></li>
<li><p>insert GBIF video tutorial here? Or have them do it in unit 1 (note: GBIF intro material lives as comments in Lab 6),</p></li>
<li><p>selected your favourite plant group for creating a species distribution map (not sure if we’re doing this)</p></li>
</ol>
<p>   </p>
<hr />
</div>
<div id="outcomes" class="section level4">
<h4>Outcomes</h4>
<p>By the end of this tutorial you will have: <br></p>
<ol style="list-style-type: decimal">
<li><p>experience manipulating and mapping species distribution data in R, <br></p></li>
<li><p>familiarity with GBIF and the types of data that can be obtained, <br></p></li>
<li><p>More?</p></li>
</ol>
<p>   </p>
<hr />
</div>
<div id="mapping-species-distributions" class="section level4">
<h4>Mapping Species Distributions</h4>
<p>In previous labs we familiarized ourselves with GBIF, R, and RStudio. Today we’ll be running a script that collects, filters, and maps distribution data for two species of “prickly pear” cacti <em>Opuntia fragilis</em> Nutt. Haw. and <em>Opuntia humifusa</em> Raf. (Opuntioideae: Cactaceae).</p>
<p>First let’s install the required packages:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">install.packages</span>(<span class="st">&quot;mapr&quot;</span>, <span class="st">&quot;rgbif&quot;</span>, <span class="st">&quot;spocc&quot;</span>, <span class="st">&quot;taxize&quot;</span>)</span></code></pre></div>
<p>These packages are designed for connecting with the GBIF database (<code>rgbif</code>, <code>spocc</code>, <code>taxize</code>), filtering data (<code>tidyverse</code>), and mapping (<code>mapr</code>). Once installed, use the <code>library()</code> function to attach the packages (we’ll also attach <code>tidyverse</code> to help with data wrangling and plotting):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">library</span>(mapr)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">library</span>(rgbif)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">library</span>(spocc)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">library</span>(taxize)</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">library</span>(tidyverse)</span></code></pre></div>
<p>Now let’s get some occurence data from GBIF!</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># get taxon ID from GBIF</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>group1_ids &lt;-<span class="st"> </span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="st">  </span>taxize<span class="op">::</span><span class="kw">get_gbifid</span>(<span class="dt">sci=</span><span class="kw">c</span>(<span class="st">&#39;Opuntia humifusa&#39;</span>), <span class="dt">rank=</span><span class="st">&#39;species&#39;</span>, <span class="dt">limit =</span> <span class="dv">1000</span>)</span></code></pre></div>
<pre><code>## ══  1 queries  ═══════════════</code></pre>
<pre><code>## 
## Retrieving data for taxon &#39;Opuntia humifusa&#39;</code></pre>
<pre><code>## ✔  Found:  Opuntia humifusa
## ══  Results  ═════════════════
## 
## ● Total: 1 
## ● Found: 1 
## ● Not Found: 0</code></pre>
<p>The <code>get_gbifid()</code> function searches GBIF for taxon IDs associated with your search query (“<em>Opuntia humifusa</em>”). We wrote the code as <code>taxize::get_gbifid()</code> to be clear about which package the function originated from (<code>taxize</code>), but this isn’t usually necessary. The <code>&lt;-</code> operator stores the results in an object that we named <code>group1_ids</code>. By storing the results in an object we can later return to the object and inspect it, subset it, and pipe it to other functions. The output message is telling us that the <code>get_gbif()</code> function found 1 taxon ID for <em>Opuntia humifusa</em>. This is ideal because it means that there aren’t any synonyms to deal with! To find out what the taxon ID is, we’ll simply call our object <code>group1_ids</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>group1_ids</span></code></pre></div>
<pre><code>## [1] &quot;5384047&quot;
## attr(,&quot;class&quot;)
## [1] &quot;gbifid&quot;
## attr(,&quot;match&quot;)
## [1] &quot;found&quot;
## attr(,&quot;multiple_matches&quot;)
## [1] FALSE
## attr(,&quot;pattern_match&quot;)
## [1] FALSE
## attr(,&quot;uri&quot;)
## [1] &quot;https://www.gbif.org/species/5384047&quot;</code></pre>
<p>Among other things, the output tells us that the taxon ID is <code>"5384047"</code>. Now, let’s use our ‘taxon ID object’ to download occurence data directly from GBIF (this can take a minute depending on how many records there are for a taxon):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>group1_metadata &lt;-<span class="st"> </span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">  </span>spocc<span class="op">::</span><span class="kw">occ</span>(<span class="dt">ids =</span> group1_ids, <span class="dt">from =</span> <span class="st">&#39;gbif&#39;</span>, <span class="dt">limit =</span> <span class="dv">1000</span>)</span></code></pre></div>
<p>In this code we’ve created a new object called <code>group1_metadata</code>. This object contains occurence records found by the <code>occ()</code> function, where we specified our taxon ID (contained in <code>group1_ids</code>) and told the function that we wanted our data <code>from = gbif</code> (instead of another database) and that we wanted a maximum of 1000 records. Let’s inspect the structure of the <code>group1_metadata</code> object:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">str</span>(group1_metadata, <span class="dt">max.level=</span><span class="dv">1</span>)</span></code></pre></div>
<pre><code>## List of 9
##  $ gbif     :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ bison    :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ inat     :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ ebird    :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ ecoengine:List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ vertnet  :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ idigbio  :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ obis     :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  $ ala      :List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;occdatind&quot;
##  - attr(*, &quot;class&quot;)= chr &quot;occdat&quot;
##  - attr(*, &quot;searched&quot;)= chr &quot;gbif&quot;</code></pre>
<p>The output tells us that <code>group1_metadata</code> is a <code>List</code> object with 9 named elements. We are specifically interested in the named element <code>$gbif</code>, so we can simplify our object by subsetting:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>group1_simple &lt;-<span class="st"> </span>group1_metadata<span class="op">$</span>gbif<span class="op">$</span>data<span class="op">$</span><span class="st">`</span><span class="dt">5384047</span><span class="st">`</span></span></code></pre></div>
<p>While writing this code, we discovered that the <code>group1_metadata</code> object is pretty complex and with lots of layers! The code above says to take the large object <code>group1_metadata</code> and select the element named <code>$gbif</code>. Then, within the element <code>$gbif</code>, select the sub-element <code>$data</code>. Within the sub-element <code>$data</code>, select the sub-sub-element <code>5384047</code> (the taxon ID for <em>O. humifusa</em>). Inception.gif.</p>
<p>Ok, we now have some tidy GBIF data:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>group1_simple</span></code></pre></div>
<pre><code>## # A tibble: 1,000 x 98
##    name  longitude latitude issues prov  key   scientificName datasetKey
##    &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;          &lt;chr&gt;     
##  1 Opun…     -73.8     40.6 gass84 gbif  2543… Opuntia humif… 50c9509d-…
##  2 Opun…     -89.5     34.7 cdrou… gbif  2550… Opuntia humif… 50c9509d-…
##  3 Opun…     -80.2     32.6 cdrou… gbif  2550… Opuntia humif… 50c9509d-…
##  4 Opun…      35.2     44.9 cdrou… gbif  2557… Opuntia humif… 50c9509d-…
##  5 Opun…     -75.3     38.9 cdrou… gbif  2557… Opuntia humif… 50c9509d-…
##  6 Opun…      11.2     46.7 cdrou… gbif  2563… Opuntia humif… 50c9509d-…
##  7 Opun…     -81.3     27.2 cdrou… gbif  2563… Opuntia austr… 50c9509d-…
##  8 Opun…     -81.3     27.2 cdrou… gbif  2563… Opuntia austr… 50c9509d-…
##  9 Opun…     -81.9     30.1 cdrou… gbif  2563… Opuntia mesac… 50c9509d-…
## 10 Opun…      10.3     46.0 cdrou… gbif  2563… Opuntia humif… 50c9509d-…
## # … with 990 more rows, and 90 more variables: publishingOrgKey &lt;chr&gt;,
## #   installationKey &lt;chr&gt;, publishingCountry &lt;chr&gt;, protocol &lt;chr&gt;,
## #   lastCrawled &lt;chr&gt;, lastParsed &lt;chr&gt;, crawlId &lt;int&gt;, basisOfRecord &lt;chr&gt;,
## #   taxonKey &lt;int&gt;, kingdomKey &lt;int&gt;, phylumKey &lt;int&gt;, classKey &lt;int&gt;,
## #   orderKey &lt;int&gt;, familyKey &lt;int&gt;, genusKey &lt;int&gt;, speciesKey &lt;int&gt;,
## #   acceptedTaxonKey &lt;int&gt;, acceptedScientificName &lt;chr&gt;, kingdom &lt;chr&gt;,
## #   phylum &lt;chr&gt;, order &lt;chr&gt;, family &lt;chr&gt;, genus &lt;chr&gt;, species &lt;chr&gt;,
## #   genericName &lt;chr&gt;, specificEpithet &lt;chr&gt;, taxonRank &lt;chr&gt;,
## #   taxonomicStatus &lt;chr&gt;, dateIdentified &lt;chr&gt;,
## #   coordinateUncertaintyInMeters &lt;dbl&gt;, stateProvince &lt;chr&gt;, year &lt;int&gt;,
## #   month &lt;int&gt;, day &lt;int&gt;, eventDate &lt;date&gt;, modified &lt;chr&gt;,
## #   lastInterpreted &lt;chr&gt;, references &lt;chr&gt;, license &lt;chr&gt;,
## #   geodeticDatum &lt;chr&gt;, class &lt;chr&gt;, countryCode &lt;chr&gt;, recordedByIDs &lt;list&gt;,
## #   identifiedByIDs &lt;list&gt;, country &lt;chr&gt;, rightsHolder &lt;chr&gt;,
## #   identifier &lt;chr&gt;, `http://unknown.org/nick` &lt;chr&gt;, verbatimEventDate &lt;chr&gt;,
## #   datasetName &lt;chr&gt;, verbatimLocality &lt;chr&gt;, gbifID &lt;chr&gt;,
## #   collectionCode &lt;chr&gt;, occurrenceID &lt;chr&gt;, taxonID &lt;chr&gt;,
## #   catalogNumber &lt;chr&gt;, recordedBy &lt;chr&gt;,
## #   `http://unknown.org/occurrenceDetails` &lt;chr&gt;, institutionCode &lt;chr&gt;,
## #   rights &lt;chr&gt;, eventTime &lt;chr&gt;, identifiedBy &lt;chr&gt;, identificationID &lt;chr&gt;,
## #   occurrenceRemarks &lt;chr&gt;, projectId &lt;chr&gt;, individualCount &lt;int&gt;,
## #   informationWithheld &lt;chr&gt;, recordNumber &lt;chr&gt;, municipality &lt;chr&gt;,
## #   language &lt;chr&gt;, type &lt;chr&gt;, ownerInstitutionCode &lt;chr&gt;,
## #   identificationRemarks &lt;chr&gt;, occurrenceStatus &lt;chr&gt;,
## #   dataGeneralizations &lt;chr&gt;, taxonConceptID &lt;chr&gt;,
## #   infraspecificEpithet &lt;chr&gt;, locality &lt;chr&gt;, habitat &lt;chr&gt;,
## #   `http://unknown.org/recordId` &lt;chr&gt;, county &lt;chr&gt;,
## #   otherCatalogNumbers &lt;chr&gt;, startDayOfYear &lt;chr&gt;,
## #   reproductiveCondition &lt;chr&gt;, collectionID &lt;chr&gt;, locationRemarks &lt;chr&gt;,
## #   verbatimElevation &lt;chr&gt;, nomenclaturalCode &lt;chr&gt;, institutionID &lt;chr&gt;,
## #   identificationVerificationStatus &lt;chr&gt;</code></pre>
<p>The output is pretty big and messy! The output tells us that it’s a <code>tibble</code> (a type of spreadsheet) with 1000 rows and 101 columns. Each row is a record of where <em>Opuntia humifusa</em> has been found or collected. Each column is some information associated with that record. While some of the columns are useful (e.g. the latitude and longitude), most columns aren’t needed (we’ll get rid of them later). Before we get to mapping, we should check our data for synonyms. The <code>unique()</code> function tells us how many unique entries exist within a column:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">unique</span>(group1_simple<span class="op">$</span>scientificName)</span></code></pre></div>
<pre><code>## [1] &quot;Opuntia humifusa Raf.&quot;          &quot;Opuntia austrina Small&quot;        
## [3] &quot;Opuntia mesacantha Raf.&quot;        &quot;Opuntia ammophila Small&quot;       
## [5] &quot;Opuntia humifusa var. humifusa&quot;</code></pre>
<p>When we searched GBIF for “<em>O. humifusa</em>” some synonyms were included in the results. We can choose to include or exclude these in the next step.</p>
<p>Let’s take a look at which countries the records come from:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">unique</span>(group1_simple<span class="op">$</span>country)</span></code></pre></div>
<pre><code>##  [1] &quot;United States of America&quot; &quot;Ukraine&quot;                 
##  [3] &quot;Italy&quot;                    &quot;Spain&quot;                   
##  [5] &quot;Bulgaria&quot;                 &quot;Brazil&quot;                  
##  [7] &quot;Canada&quot;                   &quot;Australia&quot;               
##  [9] &quot;Russian Federation&quot;       NA                        
## [11] &quot;France&quot;                   &quot;Switzerland&quot;             
## [13] &quot;Netherlands&quot;              &quot;Germany&quot;                 
## [15] &quot;India&quot;                    &quot;Austria&quot;                 
## [17] &quot;Belgium&quot;</code></pre>
<p>Even though <em>Opuntia</em> is a North and Central American clade, some records show up in Europe. These are often specimens in herbaria. We’ll create a new object that filters these out:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a>group1_fil &lt;-<span class="st">  </span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="st">  </span>group1_simple <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(scientificName<span class="op">==</span><span class="st"> &#39;Opuntia humifusa Raf.&#39;</span> <span class="op">&amp;</span><span class="st"> </span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="st">         </span>country <span class="op">==</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Canada&#39;</span>, <span class="st">&#39;United States of America&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="st">  </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</span></code></pre></div>
<p>In the code above, we used the <code>filter()</code> function to get rid of synonyms and records outside of North America. We also used the <code>select()</code> function to choose the columns needed for mapping. To string together these functions, we used the pipe operator <code>%&gt;%</code> (see R Activity 1).</p>
<p>Obtaining the data for <em>O. fragilis</em> is almost the same, but because there are many synonyms for this taxon, we’ll avoid using the GBIF ‘backbone taxonomy’ and be more specific in our search. This means including the authority names and also setting <code>method = 'lookup</code> (the default is <code>method = 'backbone'</code>):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>group2_ids &lt;-<span class="st"> </span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span>taxize<span class="op">::</span><span class="kw">get_gbifid</span>(<span class="dt">sci=</span><span class="kw">c</span>(<span class="st">&#39;Opuntia fragilis (Nutt.) Haw.&#39;</span>), <span class="dt">rank=</span><span class="st">&#39;species&#39;</span>, <span class="dt">limit =</span> <span class="dv">1000</span>, <span class="dt">method =</span> <span class="st">&#39;lookup&#39;</span>)</span></code></pre></div>
<pre><code>## ══  1 queries  ═══════════════</code></pre>
<pre><code>## 
## Retrieving data for taxon &#39;Opuntia fragilis (Nutt.) Haw.&#39;</code></pre>
<pre><code>## ✔  Found:  Opuntia fragilis (Nutt.) Haw.
## ══  Results  ═════════════════
## 
## ● Total: 1 
## ● Found: 1 
## ● Not Found: 0</code></pre>
<p>From here, the same code is run as for <em>O. humifusa</em> :</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># get occurence data from GBIF                           </span></span>
<span id="cb24-2"><a href="#cb24-2"></a>group2_metadata &lt;-<span class="st"> </span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="st">  </span>spocc<span class="op">::</span><span class="kw">occ</span>(<span class="dt">ids=</span>group2_ids, <span class="dt">from=</span><span class="st">&#39;gbif&#39;</span>, <span class="dt">limit =</span> <span class="dv">1000</span>)</span>
<span id="cb24-4"><a href="#cb24-4"></a></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="co"># discard unnecessary metadata and preserve occurence data</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: the &#39;$&#39; symbol subsets your data. To narrow in </span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co"># on the occurence data, insert the taxon ID from &#39;group2_ids&#39; </span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="co"># into the end of the subset string.</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="co"># this ID will be a different ID than Opuntia humifusa</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>group2_simple &lt;-<span class="st"> </span>group2_metadata<span class="op">$</span>gbif<span class="op">$</span>data<span class="op">$</span><span class="st">`</span><span class="dt">5384113</span><span class="st">`</span></span>
<span id="cb24-11"><a href="#cb24-11"></a></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co"># look for species synonyms</span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="kw">unique</span>(group2_simple<span class="op">$</span>scientificName)</span>
<span id="cb24-14"><a href="#cb24-14"></a></span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="co"># look for misplaced country records</span></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="kw">unique</span>(group2_simple<span class="op">$</span>country)</span>
<span id="cb24-17"><a href="#cb24-17"></a></span>
<span id="cb24-18"><a href="#cb24-18"></a><span class="co"># filter out synonyms </span></span>
<span id="cb24-19"><a href="#cb24-19"></a><span class="co"># filter out countries</span></span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="co"># also, narrow in on records that are &#39;human observations&#39;</span></span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb24-22"><a href="#cb24-22"></a></span>
<span id="cb24-23"><a href="#cb24-23"></a>group2_fil &lt;-<span class="st">  </span></span>
<span id="cb24-24"><a href="#cb24-24"></a><span class="st">  </span>group2_simple <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb24-25"><a href="#cb24-25"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(scientificName<span class="op">==</span><span class="st"> &#39;Opuntia fragilis (Nutt.) Haw.&#39;</span> <span class="op">&amp;</span><span class="st"> </span></span>
<span id="cb24-26"><a href="#cb24-26"></a><span class="st">           </span>country <span class="op">==</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Canada&#39;</span>, <span class="st">&#39;United States of America&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb24-27"><a href="#cb24-27"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</span></code></pre></div>
<p>We can then use the <code>full_join()</code> function to combine our two <em>Opuntia</em> datasets:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>combined_data&lt;-</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="st">  </span><span class="kw">full_join</span>(group1_fil, group2_fil)</span></code></pre></div>
<pre><code>## Joining, by = c(&quot;name&quot;, &quot;longitude&quot;, &quot;latitude&quot;)</code></pre>
<p>Now we’ll use the <code>map_ggplot()</code> function to map our combined occurence data. The <code>coord_fixed()</code> function adjusts the mapping window, using latitude and longitude as parameters.:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">library</span>(ggplot2)</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="kw">library</span>(mapr)</span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="kw">map_ggplot</span>(combined_data) <span class="op">+</span><span class="st"> </span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="st">  </span><span class="kw">coord_fixed</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">135</span>, <span class="dv">-55</span> ),  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">90</span>)) </span></code></pre></div>
<p><img src="BIOL_324_Lab_7_files/figure-html/chunk15-1.png" width="672" /></p>
<hr />
<p>   </p>
</div>
<div id="activity-3-creating-your-own-species-distribution-map" class="section level4">
<h4>Activity 3: Creating your own species distribution map</h4>
<p>MB: Not sure if we’re going this route.. let’s discuss!</p>
<p>MB: Basically, the existing code can be modified to replace <em>Opuntia</em> with any other plant name. Re-running the code will create a map for any species that GBIF has records for. Of course, some taxa are have more complicated nomenclature, and sometimes weird entries make it onto the map. In these cases, a little troubleshooting is required. Also, if one wanted to search for genera, families, orders, etc. some additional modifications are needed. For the majority of students in BIOL413, generating their own maps didn’t require my intervention.</p>
<p><br> <br></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
