---
title: "R Activity 2: Mapping Species Distributions using R and GBIF"
# title: "<span style='font-size: 30px'> R Assignment 2: Mapping Species Distributions using R and GBIF </style>"
author: Mannfred Boehm
date: "`r format(Sys.time(), '%d %B, %Y')`"
# output:
#   word_document:
#     fig_caption: yes
#     reference_docx: ms_word_reference.docx
# output:
#    html_document:
#    number_sections: no
#    theme: flatly
#output: github_document
#urlcolor: blue

---

#### Motivation

At its core, plant taxonomy is the science of naming and grouping plants based on their shared traits. Throughout this course we've seen how growth habit, morphology, and geographic distribution can provide valuable information about how to classify and define plants. When we consider geographic information, we are asking questions like "do the plants occupy similar or distinct habitats?" and "are the ranges of these plants disjunct or overlapping?". Depending on the answer to these questions, our decision to group or separate plants (and give them different names) can be changed dramatically. In this R activity, we'll demonstrate how we can use publically available occurence data to create distribution maps for plants and use these maps to make taxonomic decisions.  

&nbsp;
&nbsp;

---
 

#### Pre-lab 

Before starting this week's tutorial you will have: 

1. completed R Activity 1 and the pre-readings assigned there, 

2. insert GBIF video tutorial here? Or have them do it in unit 1 (note: GBIF intro material lives as comments in Lab 6),

3. selected your favourite plant group for creating a species distribution map (not sure if we're doing this)

&nbsp;
&nbsp;

---

#### Outcomes

By the end of this tutorial you will have: <br>

1. experience manipulating and mapping species distribution data in R, <br>

2. familiarity with GBIF and the types of data that can be obtained, <br>

3. More?

&nbsp;
&nbsp;

---

#### Mapping Species Distributions

In previous labs we familiarized ourselves with GBIF, R, and RStudio. Today we'll be running a script that collects, filters, and maps distribution data for two species of "prickly pear" cacti _Opuntia fragilis_ Nutt. Haw. and _Opuntia humifusa_ Raf. (Opuntioideae: Cactaceae). 

First let's install the required packages:

```{r, eval = FALSE}
install.packages("mapr", "rgbif", "spocc", "taxize")
```

These packages are designed for connecting with the GBIF database (`rgbif`, `spocc`, `taxize`), filtering data (`tidyverse`), and mapping (`mapr`). Once installed, use the `library()` function to attach the packages (we'll also attach `tidyverse` to help with data wrangling and plotting):

```{r, eval = FALSE}
library(mapr)
library(rgbif)
library(spocc)
library(taxize)
library(tidyverse)
```

Now let's get some occurence data from GBIF! 

```{r}
# get taxon ID from GBIF
group1_ids <- 
  taxize::get_gbifid(sci=c('Opuntia humifusa'), rank='species')
```

The `get_gbifid()` function searches GBIF for taxon IDs associated with your search query ("*Opuntia humifusa*"). We wrote the code as `taxize::get_gbifid()` to be clear about which package the function originated from (`taxize`), but this isn't usually necessary. The `<-` operator stores the results in an object that we named `group1_ids`. By storing the results in an object we can later return to the object and inspect it, subset it, and pipe it to other functions. The output message is telling us that the `get_gbif()` function found 1 taxon ID for *Opuntia humifusa*. This is ideal because it means that there aren't any synonyms to deal with! To find out what the taxon ID is, we'll simply call our object `group1_ids`:

```{r}
group1_ids
```

Among other things, the output tells us that the taxon ID is `"5384047"`. Now, let's use our 'taxon ID object' to download occurence data directly from GBIF (this can take a minute depending on how many records there are for a taxon):

```{r}
group1_metadata <- 
  spocc::occ(ids = group1_ids, from = 'gbif', limit = 1000)
```

In this code we've created a new object called `group1_metadata`. This object contains occurence records found by the `occ()` function, where we specified our taxon ID (contained in `group1_ids`) and told the function that we wanted our data `from = gbif` (instead of another database) and that we wanted a maximum of 1000 records. Let's inspect the structure of the `group1_metadata` object:

```{r}
str(group1_metadata, max.level=1)
```

The output tells us that `group1_metadata` is a `List` object with 9 named elements. We are specifically interested in the named element `$gbif`, so we can simplify our object by subsetting:

```{r}
group1_simple <- group1_metadata$gbif$data$`5384047`
```

While writing this code, we discovered that the `group1_metadata` object is pretty complex and with lots of layers! The code above says to take the large object `group1_metadata` and select the element named `$gbif`. Then, within the element `$gbif`, select the sub-element `$data`. Within the sub-element `$data`, select the sub-sub-element `5384047` (the taxon ID for _O. humifusa_). Inception.gif.



```{r}
group1_metadata$gbif
```

The output is pretty big and messy! The output tells us that it's a `tibble` (a type of spreadsheet) with 1000 rows and 101 columns. Each row is a record of where _Opuntia humifusa_ has been found or collected. Each column is some information associated with that record. While some of the columns are useful (e.g. the latitude and longitude), most columns aren't needed. Let's simplify this `tibble` object by subsetting:



Here, we are subsetting the large object `group1_metadata` into a smaller object `group1_simple`. By doing this, we discard the superfluous information that was collected by the `occ()` function. We can choose which elements to keep by using the `$` operator. The code `group1_metadata$gbif$data$'5384047'` says: 



We are left then with an object `group1_data` that is considerably more simple to navigate than `group1_metadata`.




Obtaining the data for _O. fragilis_ requires an additional step. Highlight lines 62-63 and run the code. In the **Console Pane** a warning will appear stating `More than one GBIF ID found for taxon 'Opuntia fragilis'!`, and listing possible matches to the search query. We'll select the first option by typing "1" (without quotation marks) into the **Console Pane** and pressing **Enter**. Now, select lines 67-108 in the **Source Pane** and run the rest of the code. 
After it has executed, a map will be generated in the **Plots** tab of the **Files Pane**. In the **Plots** tab, click **Zoom** to adjust the image dimensions. 

MB: Any other plants could go here. I chose these somewhat haphazardly, but they do show a distribution that could be used to discuss allopatry. 

---

<br>
<br>


#### Activity 2: Deciphering some code









**Line 40**: The `unique()` function is applied to the `$ScientificName` column of `group1_data`. This function inspects the specified column and tells us how many unique entries exist there. In the **Console Pane** the output tells us that there are some synonyms that have been included.

MB: There's an opporunity here to teach about synonyms and how to make decisions about including/excluding them. 

**Line 43**: Similarly, the `unique()` function is applied to the `$country` column of `group1_data`. In the **Console Pane** the output tells us that some records from Eurasia have been included. These are likely museum specimens, not natural observations. 

**Lines 49-54**: We can remove synonyms and misplaced country records by using the `filter()` function. The `select()` function chooses columns 1,2, and 3, which store the plant name, latitude, and longitude, respectively.

**Lines 62-94**: The above steps are repeated for _O. fragilis_.

**Lines 101-102**: The `full_join()` function combines the occurence data for _O. humifusa_ and _O. fragilis_. 

**Lines 107-108**: The `map_ggplot()` function maps the combined data. The `coord_fixed()` function adjusts the mapping window, using latitude and longitude as parameters.

**The result**:

![Figure 1: Distribution map for _O. humifusa_ and _O. fragilis_.](opuntia_dist.png)

---

<br>
<br>


#### Activity 3: Creating your own species distribution map

MB: Basically, the existing code can be modified to replace _Opuntia_ with any other plant name. Re-running the code will create a map for any species that GBIF has records for. Of course, some taxa are have more complicated nomenclature, and sometimes weird entries make it onto the map. In these cases, a little troubleshooting is required. Also, if one wanted to search for genera, families, orders, etc. some additional modifications are needed. For the majority of students in BIOL413, generating their own maps didn't require my intervention. 

<br>
<br>



